<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Job â€“ Skreenit</title>

  <link rel="stylesheet" href="https://auth.skreenit.com/assets/css/shared-styles.css" />
  <link rel="stylesheet" href="https://auth.skreenit.com/assets/css/dashboard-styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body>
  <div class="dashboard-container">

    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <img src="https://auth.skreenit.com/assets/images/logo.png" alt="Skreenit" />
        </div>
      </div>

      <ul class="nav-menu">
        <li class="nav-item" data-section="overview">
          <i class="fas fa-tachometer-alt"></i><span>Overview</span>
        </li>
        <li class="nav-item active" data-section="jobs">
          <i class="fas fa-briefcase"></i><span>Jobs</span>
        </li>
        <li class="nav-item" data-section="candidates">
          <i class="fas fa-users"></i><span>Candidates</span>
        </li>
        <li class="nav-item" data-section="analytics">
          <i class="fas fa-chart-bar"></i><span>Analytics</span>
        </li>
      </ul>

      <div class="sidebar-footer">
        <div class="user-info">
          <img src="https://via.placeholder.com/40" class="user-avatar" />
          <div class="user-details">
            <span class="user-name">Loading...</span>
            <span class="user-role">Recruiter</span>
          </div>
        </div>
        <button id="logoutBtn" class="logout-btn" aria-label="Logout">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <section class="dashboard-section">
        <div class="section-header">
          <h1>Edit Job</h1>
        </div>

        <form id="editJobForm" class="form-card">

          <div class="form-group">
            <label for="job_title">Job Title *</label>
            <input type="text" id="job_title" required />
          </div>

          <div class="form-group">
            <label for="job_location">Location *</label>
            <input type="text" id="job_location" required />
          </div>

          <div class="form-group">
            <label for="job_type">Job Type *</label>
            <select id="job_type" required>
              <option value="">Select Type</option>
              <option>Full-time</option>
              <option>Part-time</option>
              <option>Contract</option>
              <option>Internship</option>
            </select>
          </div>

          <div class="form-group">
            <label for="salary_range">Salary Range</label>
            <input type="text" id="salary_range" />
          </div>

          <div class="form-group">
            <label for="job_description">Job Description *</label>
            <textarea id="job_description" rows="6" required></textarea>
          </div>

          <div class="form-group">
            <label for="requirements">Requirements *</label>
            <textarea id="requirements" rows="5" required></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Update Job</button>
            <button type="button" id="deleteJobBtn" class="btn btn-danger">Delete Job</button>
          </div>
        </form>
      </section>
    </main>
  </div>

  <!-- Embedded JS -->
  <script type="module">
    import { supabase } from "https://auth.skreenit.com/assets/js/supabase-config.js";
    import {
      backendGet,
      backendPut,
      backendDelete,
      handleResponse
    } from "https://auth.skreenit.com/assets/js/backend-client.js";

    // --- Role check ---
    async function ensureRecruiter() {
      const { data: { user } } = await supabase.auth.getUser();
      const role = user?.user_metadata?.role;

      if (role !== "recruiter") {
        window.location.href = "https://login.skreenit.com/login";
        return;
      }

      const nameEl = document.querySelector(".user-name");
      if (nameEl) nameEl.textContent = user?.email || "Recruiter";
    }

    // --- Get job_id from URL ---
    function getJobId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("job_id");
    }

    // --- API helpers ---
    async function loadJob(jobId) {
      const res = await backendGet(`/recruiter/jobs/${encodeURIComponent(jobId)}`);
      return await handleResponse(res);
    }

    async function updateJob(jobId, payload) {
      const res = await backendPut(`/recruiter/jobs/${encodeURIComponent(jobId)}`, payload);
      return await handleResponse(res);
    }

    async function deleteJob(jobId) {
      const res = await backendDelete(`/recruiter/jobs/${encodeURIComponent(jobId)}`);
      return await handleResponse(res);
    }

    // --- Init form ---
    async function initJobEditForm() {
      const form = document.getElementById("editJobForm");
      const deleteBtn = document.getElementById("deleteJobBtn");
      if (!form) return;

      const jobId = getJobId();
      if (!jobId) {
        alert("Missing job ID.");
        window.location.href = "https://dashboard.skreenit.com/recruiter-dashboard.html";
        return;
      }

      const titleEl = document.getElementById("job_title");
      const locationEl = document.getElementById("job_location");
      const typeEl = document.getElementById("job_type");
      const salaryEl = document.getElementById("salary_range");
      const descEl = document.getElementById("job_description");
      const reqEl = document.getElementById("requirements");

      // Load existing job
      try {
        const job = await loadJob(jobId);

        if (titleEl) titleEl.value = job.title || "";
        if (locationEl) locationEl.value = job.location || "";
        if (typeEl) typeEl.value = job.job_type || "";
        if (salaryEl) salaryEl.value = job.salary_range || "";
        if (descEl) descEl.value = job.description || "";
        if (reqEl) reqEl.value = job.requirements || "";
      } catch (err) {
        console.error("Failed to load job:", err);
        alert("Failed to load job details.");
      }

      // Submit handler
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = {
          title: titleEl.value.trim(),
          location: locationEl.value.trim(),
          job_type: typeEl.value,
          salary_range: salaryEl.value.trim() || null,
          description: descEl.value.trim(),
          requirements: reqEl.value.trim(),
          skills: [] // optional, not in UI
        };

        if (!payload.title || !payload.location || !payload.job_type || !payload.description || !payload.requirements) {
          alert("Please fill all required fields.");
          return;
        }

        const submitBtn = form.querySelector("button[type='submit']");
        submitBtn.disabled = true;

        try {
          await updateJob(jobId, payload);
          alert("Job updated successfully!");
          window.location.href = "https://dashboard.skreenit.com/recruiter-dashboard.html";
        } catch (err) {
          console.error("Job update failed:", err);
          alert("Failed to update job. Please try again.");
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Delete handler
      if (deleteBtn) {
        deleteBtn.addEventListener("click", async () => {
          if (!confirm("Are you sure you want to delete this job?")) return;

          deleteBtn.disabled = true;

          try {
            await deleteJob(jobId);
            alert("Job deleted.");
            window.location.href = "https://dashboard.skreenit.com/recruiter-dashboard.html";
          } catch (err) {
            console.error("Job delete failed:", err);
            alert("Failed to delete job. Please try again.");
          } finally {
            deleteBtn.disabled = false;
          }
        });
      }
    }

    // --- Logout ---
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.href = "https://login.skreenit.com/login";
      });
    }

    // --- Main ---
    document.addEventListener("DOMContentLoaded", async () => {
      await ensureRecruiter();
      await initJobEditForm();
    });
  </script>
</body>
</html>
