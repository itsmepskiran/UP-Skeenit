<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skreenit - Update Password</title>
  <link rel="icon" type="image/x-icon" href="https://auth.skreenit.com/assets/images/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://auth.skreenit.com/assets/images/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://auth.skreenit.com/assets/images/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://auth.skreenit.com/assets/images/apple-touch-icon.png" />
  <link rel="manifest" href="https://auth.skreenit.com/assets/images/android-chrome-192x192.png" />
  <link rel="stylesheet" href="https://auth.skreenit.com/assets/css/shared-styles.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <script>
    window.__SKREENIT_BACKEND_URL__ = 'https://aiskreenit.onrender.com,https://aiskreenit.netlify.app';
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<!-- Floating decorative elements -->
  <div class="floating-elements">
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
  </div>
  <a href="https://www.skreenit.com" class="logo-link animate-pulse">
    <img src="https://auth.skreenit.com/assets/images/logo.png" alt="Skreenit" class="animate-pulse" />
  </a>
  
  <div class="auth-wrapper animate-slideInScale">
    <img src="https://auth.skreenit.com/assets/images/logobrand.png" alt="Skreenit" class="brand-image" />
    <div class="auth-header">
      <h1>
        <i class="fas fa-key"></i>
        Set Your Password
      </h1>
      <p>Create a secure password for your account</p>
    </div>
    <!-- Error Message -->
    <div id="error-message" class="alert alert-error hidden">
      <i class="fas fa-exclamation-circle"></i>
      <span id="error-text"></span>
    </div>
    <!-- Success Message -->
    <div id="success-message" class="alert alert-success hidden">
      <i class="fas fa-check-circle"></i>
      <span id="success-text"></span>
    </div>
    <form id="passwordForm">
      <div class="form-group">
        <label for="password">New Password</label>
        <div class="input-group">
          <input 
            type="password" 
            id="password" 
            name="password" 
            placeholder="Enter your new password" 
            required
            minlength="8"
            autocomplete="new-password"
          />
          <button type="button" class="toggle-password" aria-label="Toggle password visibility">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="password-strength">
          <div id="password-strength-fill" class="password-strength-fill"></div>
        </div>
        <div class="password-requirements">
          <p>Password must contain:</p>
          <ul>
            <li id="req-length">At least 8 characters</li>
            <li id="req-uppercase">1 uppercase letter</li>
            <li id="req-lowercase">1 lowercase letter</li>
            <li id="req-number">1 number</li>
            <li id="req-special">1 special character</li>
          </ul>
        </div>
      </div>
      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <div class="input-group">
          <input 
            type="password" 
            id="confirmPassword" 
            name="confirmPassword" 
            placeholder="Confirm your new password" 
            required
            minlength="8"
            autocomplete="new-password"
          />
          <button type="button" class="toggle-password" aria-label="Toggle password visibility">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>
      <button type="submit" class="btn" id="submitBtn">
        <i class="fas fa-save"></i> Set Password
      </button>
    </form>
    <div class="auth-footer">
      <p>Remember your password? <a href="login.html">Sign in</a></p>
    </div>
  </div>
  <script>
    // Get the backend URL from the global variable or use a default
    const BACKEND_URL = window.__SKREENIT_BACKEND_URL__ || 'https://aiskreenit.onrender.com';
    
    // Password strength checker
    function checkPasswordStrength(password) {
      const strength = {
        hasMinLength: password.length >= 8,
        hasUppercase: /[A-Z]/.test(password),
        hasLowercase: /[a-z]/.test(password),
        hasNumber: /[0-9]/.test(password),
        hasSpecialChar: /[!@#$%^&*(),.?":{}|<>]/.test(password)
      };
      
      // Calculate strength score (0-100)
      const score = Object.values(strength).filter(Boolean).length * 20;
      
      return {
        score,
        strength,
        isStrong: Object.values(strength).every(Boolean)
      };
    }
    
    // Update password strength UI
    function updatePasswordStrength(password) {
      const strength = checkPasswordStrength(password);
      const strengthFill = document.getElementById('password-strength-fill');
      const requirements = {
        'req-length': strength.strength.hasMinLength,
        'req-uppercase': strength.strength.hasUppercase,
        'req-lowercase': strength.strength.hasLowercase,
        'req-number': strength.strength.hasNumber,
        'req-special': strength.strength.hasSpecialChar
      };
      
      // Update requirement indicators
      Object.entries(requirements).forEach(([id, isValid]) => {
        const element = document.getElementById(id);
        if (isValid) {
          element.classList.add('valid');
        } else {
          element.classList.remove('valid');
        }
      });
      
      // Update strength meter
      strengthFill.style.width = `${strength.score}%`;
      
      // Update strength meter color
      if (strength.score <= 20) {
        strengthFill.style.backgroundColor = '#EF4444'; // Red
      } else if (strength.score <= 60) {
        strengthFill.style.backgroundColor = '#F59E0B'; // Amber
      } else if (strength.score <= 80) {
        strengthFill.style.backgroundColor = '#3B82F6'; // Blue
      } else {
        strengthFill.style.backgroundColor = '#10B981'; // Green
      }
      
      return strength.isStrong;
    }
    
    // Toggle password visibility
    document.querySelectorAll('.toggle-password').forEach(button => {
      button.addEventListener('click', function() {
        const input = this.previousElementSibling;
        const icon = this.querySelector('i');
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      });
    });
    
    // Handle form submission
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      const successDiv = document.getElementById('success-message');
      const successText = document.getElementById('success-text');
      const submitBtn = document.getElementById('submitBtn');
      
      // Reset messages
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      
      // Basic validation
      if (password !== confirmPassword) {
        errorText.textContent = 'Passwords do not match';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      // Check password strength
      const isStrong = updatePasswordStrength(password);
      if (!isStrong) {
        errorText.textContent = 'Please ensure your password meets all requirements';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      try {
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        let token = urlParams.get('access_token');
        
        // If not in hash, try query params
        if (!token) {
          const queryParams = new URLSearchParams(window.location.search);
          token = queryParams.get('token');
        }
        
        if (!token) {
          throw new Error('No token found in URL. Please use the link from your email.');
        }
        
        // Disable submit button and show loading state
        submitBtn.disabled = true;
        submitBtn.classList.add('loading');
        submitBtn.innerHTML = 'Updating...';
        
        // Call the update password endpoint
        const formData = new FormData();
        formData.append('token', token);
        formData.append('new_password', password);
        
        const response = await fetch(`${BACKEND_URL}/auth/update-password`, {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.detail || 'Failed to update password. Please try again.');
        }
        
        // Show success message
        successText.textContent = 'Password updated successfully! Redirecting to login...';
        successDiv.classList.remove('hidden');
        
        // Redirect to login after 3 seconds
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 3000);
        
      } catch (error) {
        console.error('Error:', error);
        errorText.textContent = error.message || 'An error occurred. Please try again.';
        errorDiv.classList.remove('hidden');
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Set Password';
      }
    });
    
    // Real-time password strength feedback
    document.getElementById('password').addEventListener('input', function() {
      updatePasswordStrength(this.value);
    });
    
    // Check if there's a token in the URL on page load
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.hash.substring(1));
      const token = urlParams.get('access_token') || 
                   new URLSearchParams(window.location.search).get('token');
      
      if (!token) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        errorText.textContent = 'Invalid or missing token. Please use the link from your email.';
        errorDiv.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>