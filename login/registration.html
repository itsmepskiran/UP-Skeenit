<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skreenit - Registration</title>

  <link rel="icon" type="image/png" sizes="32x32" href="https://auth.skreenit.com/assets/images/favicon-32x32.png" />
  <link rel="stylesheet" href="https://auth.skreenit.com/assets/css/shared-styles.css" />
  <link rel="stylesheet" href="https://auth.skreenit.com/assets/css/auth.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <script>
    window.__SKREENIT_BACKEND_URL__ = 'https://aiskreenit.onrender.com';
    // Supabase configuration
    window.SKREENIT_SUPABASE_URL = 'https://gfkbqhniopgcaapolzbu.supabase.co';
    window.SKREENIT_SUPABASE_ANON_KEY = 'sb_publishable_ai0_qhGdNzNAUVabNOJT4g_rpGIGfqX';
  </script>
  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<!-- Decorative elements (safe) -->
<div class="floating-elements" style="pointer-events:none;">
  <div class="floating-circle"></div>
  <div class="floating-circle"></div>
  <div class="floating-circle"></div>
  <div class="floating-circle"></div>
</div>

<a href="https://skreenit.com" class="logo-link">
  <img src="https://auth.skreenit.com/assets/images/logo.png" alt="Skreenit" />
</a>

<div class="auth-wrapper">
  <img src="https://auth.skreenit.com/assets/images/logobrand.png" class="brand-image" />

  <div class="auth-header">
    <h1><i class="fas fa-user-plus"></i> Join Skreenit</h1>
    <p>Create your account and start your journey</p>
  </div>

  <div class="auth-body">
    <div id="formError" class="error-message"></div>

    <form id="registrationForm">

      <!-- BASIC INFO -->
      <div class="form-row">
        <div class="form-group">
          <label>Full Name*</label>
          <input type="text" name="full_name" required />
        </div>
        <div class="form-group">
          <label>Mobile*</label>
          <input type="text" name="mobile" required />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Email*</label>
          <input type="email" name="email" required />
        </div>
        <div class="form-group">
          <label>Location*</label>
          <input type="text" name="location" required />
        </div>
      </div>

      <!-- ROLE -->
      <div class="form-group">
        <label>Register as*</label>
        <select id="role" name="role" required>
          <option value="">Select your role</option>
          <option value="candidate">üéØ Candidate</option>
          <option value="recruiter">üè¢ Recruiter</option>
        </select>
      </div>

      <!-- ROLE BASED FIELDS (HIDDEN INITIALLY) -->
      <div id="roleBasedFields" style="display:none;">

        <!-- Recruiter -->
        <div id="recruiterFields" class="hidden">
          <div class="form-group">
            <label>üè¢ Company Name*</label>
            <input type="text" name="company_name" />
          </div>
        </div>

        <!-- Candidate -->
        <div id="candidateFields" class="hidden">
          <div class="form-group">
            <label>üìÑ Resume</label>
            <input type="file" name="resume" />
            <div class="password-hint">Upload your resume for better matches</div>
          </div>
        </div>

      </div>

      <button type="submit" class="btn btn-primary btn-large" style="width:100%;">
        <i class="fas fa-rocket"></i> Create Account
      </button>

    </form>
  </div>
</div>

<!-- ROLE TOGGLE LOGIC -->
<script type="module">
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('registrationForm');
  const errorDiv = document.getElementById('formError');
  const roleSelect = document.getElementById('role');

  // Initialize Supabase client
  const { createClient } = supabase;
  const supabaseClient = createClient(
    window.SKREENIT_SUPABASE_URL,
    window.SKREENIT_SUPABASE_ANON_KEY
  );

  // Generate temporary password for Supabase signup
  function generateTempPassword() {
    return Math.random().toString(36).slice(-10);
  }

  // Show message helper
  function showMessage(message, type = 'error') {
    errorDiv.textContent = message;
    errorDiv.className = `alert alert-${type}`;
    errorDiv.style.display = 'block';

    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 5000);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);

    const email = formData.get('email');
    const role = roleSelect.value;

    const userMetadata = {
      full_name: formData.get('full_name'),
      mobile: formData.get('mobile'),
      location: formData.get('location'),
      role,
      ...(role === 'recruiter' && { company_name: formData.get('company_name') })
    };

    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';

    try {
      // 1Ô∏è‚É£ CREATE USER IN SUPABASE (with temp password)
      const tempPassword = generateTempPassword();

      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password: tempPassword,
        options: {
          data: userMetadata,
          emailRedirectTo: `${window.location.origin}/update-password.html`
        }
      });

      if (error) throw error;

      // 2Ô∏è‚É£ REGISTER USER IN BACKEND
      await fetch(`${window.__SKREENIT_BACKEND_URL__}/auth/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email,
          full_name: userMetadata.full_name,
          mobile: userMetadata.mobile,
          location: userMetadata.location,
          role,
          company_name: userMetadata.company_name || null
        })
      });

      // 3Ô∏è‚É£ SUCCESS MESSAGE
      showMessage(
        'Registration successful! Please check your email to confirm your account and set your password.',
        'success'
      );

      form.reset();

      // 4Ô∏è‚É£ REDIRECT TO LOGIN
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 3000);

    } catch (err) {
      console.error('Registration error:', err);
      showMessage(err.message || 'Registration failed. Please try again.', 'error');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-rocket"></i> Create Account';
    }
  });
});
</script>
</body>
</html>
