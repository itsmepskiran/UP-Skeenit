<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skreenit - Registration</title>

  <link rel="icon" type="image/png" sizes="32x32" href="https://auth.skreenit.com/assets/images/favicon-32x32.png" />
  <link rel="stylesheet" href="https://auth.skreenit.com/assets/css/shared-styles.css" />
  <link rel="stylesheet" href="https://auth.skreenit.com/assets/css/auth.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <style>
    .alert {
      padding: 12px 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .alert-error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .hidden { display:none !important; }
    .btn-loading { opacity:0.7; cursor:not-allowed; }
  </style>

  <script>
    window.__SKREENIT_BACKEND_URL__ = "https://aiskreenit.onrender.com/api/v1";
    window.SKREENIT_SUPABASE_URL = "https://gfkbqhniopgcaapolzbu.supabase.co";
    window.SKREENIT_SUPABASE_ANON_KEY = "sb_publishable_ai0_qhGdNzNAUVabNOJT4g_rpGIGfqX";
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<div class="floating-elements" style="pointer-events:none;">
  <div class="floating-circle"></div>
  <div class="floating-circle"></div>
  <div class="floating-circle"></div>
  <div class="floating-circle"></div>
</div>

<a href="https://skreenit.com" class="logo-link">
  <img src="https://auth.skreenit.com/assets/images/logo.png" alt="Skreenit" />
</a>

<div class="auth-wrapper">
  <img src="https://auth.skreenit.com/assets/images/logobrand.png" class="brand-image" />

  <div class="auth-header">
    <h1><i class="fas fa-user-plus"></i> Join Skreenit</h1>
    <p>Create your account and start your journey</p>
  </div>

  <div class="auth-body">
    <div id="formError" class="alert alert-error hidden"></div>
    <div id="successMessage" class="alert alert-success hidden"></div>

    <form id="registrationForm">
      <div class="form-row">
        <div class="form-group">
          <label>Full Name*</label>
          <input type="text" name="full_name" required />
        </div>
        <div class="form-group">
          <label>Mobile*</label>
          <input type="tel" name="mobile" required />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Email*</label>
          <input type="email" name="email" required />
        </div>
        <div class="form-group">
          <label>Location*</label>
          <input type="text" name="location" required />
        </div>
      </div>

      <div class="form-group">
        <label>Register as*</label>
        <select id="role" name="role" required>
          <option value="">Select your role</option>
          <option value="candidate">üéØ Candidate</option>
          <option value="recruiter">üè¢ Recruiter</option>
        </select>
      </div>

      <div id="recruiterFields" class="hidden">
        <div class="form-group">
          <label>üè¢ Company Name*</label>
          <input type="text" name="company_name" />
        </div>
      </div>

      <button type="submit" class="btn btn-primary btn-large" style="width:100%;">
        <i class="fas fa-rocket"></i> Create Account
      </button>
    </form>
  </div>
</div>

<script type="module">
document.addEventListener("DOMContentLoaded", () => {
  const { createClient } = supabase;
  const supabaseClient = createClient(
    window.SKREENIT_SUPABASE_URL,
    window.SKREENIT_SUPABASE_ANON_KEY
  );

  const form = document.getElementById("registrationForm");
  const errorDiv = document.getElementById("formError");
  const successDiv = document.getElementById("successMessage");
  const roleSelect = document.getElementById("role");
  const recruiterFields = document.getElementById("recruiterFields");

  roleSelect.addEventListener("change", () => {
    recruiterFields.classList.toggle("hidden", roleSelect.value !== "recruiter");
  });

  function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.classList.remove("hidden");
    setTimeout(() => errorDiv.classList.add("hidden"), 5000);
  }

  function showSuccess(msg) {
    successDiv.textContent = msg;
    successDiv.classList.remove("hidden");
    form.style.opacity = "0.6";
    form.style.pointerEvents = "none";

    setTimeout(() => {
      window.location.href = "login.html?registered=true";
    }, 5000);
  }

  function generateTempPassword() {
    const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()";
    return Array.from(crypto.getRandomValues(new Uint32Array(16)))
      .map(v => chars[v % chars.length])
      .join("");
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const submitBtn = form.querySelector("button[type='submit']");
    const originalText = submitBtn.innerHTML;

    try {
      submitBtn.disabled = true;
      submitBtn.classList.add("btn-loading");
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';

      const formData = new FormData(form);
      const email = formData.get("email").trim();
      const role = formData.get("role");

      const userMetadata = {
        full_name: formData.get("full_name").trim(),
        mobile: formData.get("mobile").trim(),
        location: formData.get("location").trim(),
        role,
        ...(role === "recruiter" && { company_name: formData.get("company_name").trim() })
      };

      const tempPassword = generateTempPassword();

      const { error: supabaseError } = await supabaseClient.auth.signUp({
        email,
        password: tempPassword,
        options: {
          data: userMetadata,
          emailRedirectTo: `${window.location.origin}/update-password.html`
        }
      });

      if (supabaseError) throw supabaseError;

      const backendForm = new FormData();
      backendForm.append("full_name", userMetadata.full_name);
      backendForm.append("email", email);
      backendForm.append("mobile", userMetadata.mobile);
      backendForm.append("location", userMetadata.location);
      backendForm.append("role", role);
      if (role === "recruiter") backendForm.append("company_name", userMetadata.company_name);

      const backendResponse = await fetch(
        `${window.__SKREENIT_BACKEND_URL__}/auth/register`,
        { method: "POST", body: backendForm }
      );

      if (!backendResponse.ok) {
        const err = await backendResponse.json().catch(() => ({}));
        throw new Error(err.message || "Backend registration failed");
      }

      showSuccess("Registration successful! Please check your email to confirm your account.");

    } catch (err) {
      console.error(err);
      showError(err.message || "Registration failed. Please try again.");
    } finally {
      submitBtn.disabled = false;
      submitBtn.classList.remove("btn-loading");
      submitBtn.innerHTML = originalText;
    }
  });
});
</script>

</body>
</html>
