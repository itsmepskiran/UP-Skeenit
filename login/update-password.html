<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Skreenit - Update Password</title>
  <link rel="icon" type="image/x-icon" href="https://auth.skreenit.com/assets/images/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://auth.skreenit.com/assets/images/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://auth.skreenit.com/assets/images/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://auth.skreenit.com/assets/images/apple-touch-icon.png" />
  <link rel="manifest" href="https://auth.skreenit.com/assets/images/android-chrome-192x192.png" />
  <link rel="stylesheet" href="https://auth.skreenit.com/assets/css/shared-styles.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* Add any additional styles here */
    .hidden {
      display: none;
    }
    .loading {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .password-strength {
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin: 8px 0;
      overflow: hidden;
    }
    .password-strength-fill {
      height: 100%;
      width: 0;
      transition: width 0.3s ease, background-color 0.3s ease;
    }
    .password-requirements {
      margin: 10px 0;
      font-size: 0.85em;
      color: #666;
    }
    .password-requirements ul {
      list-style: none;
      padding-left: 5px;
      margin: 5px 0 0 0;
    }
    .password-requirements li {
      margin-bottom: 3px;
      display: flex;
      align-items: center;
    }
    .password-requirements li:before {
      content: "•";
      margin-right: 8px;
      color: #999;
    }
    .password-requirements li.valid {
      color: #10B981;
    }
    .password-requirements li.valid:before {
      content: "✓";
      color: #10B981;
    }
  </style>
</head>
<body>
  <!-- Floating decorative elements -->
  <div class="floating-elements">
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
    <div class="floating-circle"></div>
  </div>
  
  <a href="https://www.skreenit.com" class="logo-link animate-pulse">
    <img src="https://auth.skreenit.com/assets/images/logo.png" alt="Skreenit" class="animate-pulse" />
  </a>
  
  <div class="auth-wrapper animate-slideInScale">
    <img src="https://auth.skreenit.com/assets/images/logobrand.png" alt="Skreenit" class="brand-image" />
    <div class="auth-header">
      <h1>
        <i class="fas fa-key"></i>
        Set Your Password
      </h1>
      <p>Create a secure password for your account</p>
    </div>
    
    <!-- Error Message -->
    <div id="error-message" class="alert alert-error hidden">
      <i class="fas fa-exclamation-circle"></i>
      <span id="error-text"></span>
    </div>
    
    <!-- Success Message -->
    <div id="success-message" class="alert alert-success hidden">
      <i class="fas fa-check-circle"></i>
      <span id="success-text"></span>
    </div>
    
    <form id="passwordForm">
      <div class="form-group">
        <label for="password">New Password</label>
        <div class="input-group">
          <input 
            type="password" 
            id="password" 
            name="password" 
            placeholder="Enter your new password" 
            required
            minlength="8"
            autocomplete="new-password"
          />
          <button type="button" class="toggle-password" aria-label="Toggle password visibility">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="password-strength">
          <div id="password-strength-fill" class="password-strength-fill"></div>
        </div>
        <div class="password-requirements">
          <p>Password must contain:</p>
          <ul>
            <li id="req-length">At least 8 characters</li>
            <li id="req-uppercase">1 uppercase letter</li>
            <li id="req-lowercase">1 lowercase letter</li>
            <li id="req-number">1 number</li>
            <li id="req-special">1 special character</li>
          </ul>
        </div>
      </div>
      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <div class="input-group">
          <input 
            type="password" 
            id="confirmPassword" 
            name="confirmPassword" 
            placeholder="Confirm your new password" 
            required
            minlength="8"
            autocomplete="new-password"
          />
          <button type="button" class="toggle-password" aria-label="Toggle password visibility">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>
      <button type="submit" class="btn" id="submitBtn">
        <i class="fas fa-save"></i> Set Password
      </button>
    </form>
    
    <div class="auth-footer">
      <p>Remember your password? <a href="login.html">Sign in</a></p>
    </div>
  </div>

  <script>
    // Get the backend URL from the global variable or use a default
    const BACKEND_URL = window.__SKREENIT_BACKEND_URL__ || 'https://aiskreenit.onrender.com';
    
    // Password strength checker
    function checkPasswordStrength(password) {
      const strength = {
        hasMinLength: password.length >= 8,
        hasUppercase: /[A-Z]/.test(password),
        hasLowercase: /[a-z]/.test(password),
        hasNumber: /[0-9]/.test(password),
        hasSpecialChar: /[!@#$%^&*(),.?":{}|<>]/.test(password)
      };
      
      // Calculate strength score (0-100)
      const score = Object.values(strength).filter(Boolean).length * 20;
      
      return {
        score,
        strength,
        isStrong: Object.values(strength).every(Boolean)
      };
    }
    
    // Update password strength UI
    function updatePasswordStrength(password) {
      const strength = checkPasswordStrength(password);
      const strengthFill = document.getElementById('password-strength-fill');
      const requirements = {
        'req-length': strength.strength.hasMinLength,
        'req-uppercase': strength.strength.hasUppercase,
        'req-lowercase': strength.strength.hasLowercase,
        'req-number': strength.strength.hasNumber,
        'req-special': strength.strength.hasSpecialChar
      };
      
      // Update requirement indicators
      Object.entries(requirements).forEach(([id, isValid]) => {
        const element = document.getElementById(id);
        if (element) {
          if (isValid) {
            element.classList.add('valid');
          } else {
            element.classList.remove('valid');
          }
        }
      });
      
      // Update strength meter
      if (strengthFill) {
        strengthFill.style.width = `${strength.score}%`;
        
        // Update strength meter color
        if (strength.score <= 20) {
          strengthFill.style.backgroundColor = '#EF4444'; // Red
        } else if (strength.score <= 60) {
          strengthFill.style.backgroundColor = '#F59E0B'; // Amber
        } else if (strength.score <= 80) {
          strengthFill.style.backgroundColor = '#3B82F6'; // Blue
        } else {
          strengthFill.style.backgroundColor = '#10B981'; // Green
        }
      }
      
      return strength.isStrong;
    }
    
    // Toggle password visibility
    document.querySelectorAll('.toggle-password').forEach(button => {
      button.addEventListener('click', function() {
        const input = this.previousElementSibling;
        const icon = this.querySelector('i');
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      });
    });
    
    // Show error message
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      if (errorDiv && errorText) {
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
    
    // Show success message
    function showSuccess(message) {
      const successDiv = document.getElementById('success-message');
      const successText = document.getElementById('success-text');
      if (successDiv && successText) {
        successText.textContent = message;
        successDiv.classList.remove('hidden');
        successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Check for token in both hash fragment and query params
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const queryParams = new URLSearchParams(window.location.search);
      
      // Try to get token from both places
      const token = hashParams.get('access_token') || 
                   queryParams.get('token') ||
                   localStorage.getItem('auth_token');
      
      // Store the token in localStorage for later use
      if (token) {
        localStorage.setItem('auth_token', token);
      } else {
        showError('Invalid or missing token. Please use the link from your email.');
        return;
      }

      // Check if this is coming from email confirmation
      const fromConfirmation = queryParams.get('from') === 'confirmation';
      if (fromConfirmation) {
        showSuccess('Email confirmed! Please set your new password.');
      }

      // Real-time password strength feedback
      const passwordInput = document.getElementById('password');
      if (passwordInput) {
        passwordInput.addEventListener('input', function() {
          updatePasswordStrength(this.value);
        });
      }

      // Handle form submission
      const form = document.getElementById('passwordForm');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const password = document.getElementById('password').value;
          const confirmPassword = document.getElementById('confirmPassword').value;
          const submitBtn = document.getElementById('submitBtn');
          
          // Reset messages
          document.getElementById('error-message').classList.add('hidden');
          document.getElementById('success-message').classList.add('hidden');
          
          // Basic validation
          if (password !== confirmPassword) {
            showError('Passwords do not match');
            return;
          }
          
          // Check password strength
          const isStrong = updatePasswordStrength(password);
          if (!isStrong) {
            showError('Please ensure your password meets all requirements');
            return;
          }

          try {
            // Disable submit button and show loading state
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.classList.add('loading');
              submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            }
            
            const response = await fetch(`${BACKEND_URL}/auth/update-password`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              token: token,
              new_password: password
            })
          });

            const result = await response.json();
            
            if (response.ok) {
              // Clear the stored token
              localStorage.removeItem('auth_token');
              // Show success message and redirect
              showSuccess('Password updated successfully! Redirecting to login...');
              setTimeout(() => {
                window.location.href = 'login.html';
              }, 2000);
            } else {
              throw new Error(result.detail || 'Failed to update password');
            }
          } catch (error) {
            console.error('Error updating password:', error);
            showError(error.message || 'An error occurred. Please try again.');
          } finally {
            // Re-enable submit button
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.classList.remove('loading');
              submitBtn.innerHTML = '<i class="fas fa-save"></i> Set Password';
            }
          }
        });
      }
    });
  </script>
</body>
</html>